<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Web Photobooth</title>
  <style>
    body {
      font-family: sans-serif;
      background: #311183;
      color: white;
      margin: 0;
      padding: 1rem;
      height: 100vh;
      display: flex;
      flex-direction: row;
      gap: 2rem;
      overflow: hidden;
    }
    #settings {
      width: 300px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    #preview {
      flex: 1;
      overflow: auto;
      display: flex;
      justify-content: center;
      align-items: start;
      padding-top: 20px;
      position: relative;
    }
    #frameDisplay {
      position: relative;
      width: 1080px;
      height: 3456px;
    }
    .frameOverlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 1080px;
      height: 3456px;
      z-index: 10;
      pointer-events: none;
    }
    .slot {
      width: 972px;
      height: 729px;
      position: absolute;
      left: 54px;
      overflow: hidden;
    }
    .slot video, .slot img.photo {
      width: 100%;
      height: 100%;
      object-fit: cover;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 5;
    }
    select, button {
      padding: 0.5rem;
      font-size: 1rem;
      border-radius: 8px;
      border: none;
      cursor: pointer;
    }
    button {
      background: #fff;
      color: #311183;
    }
    h1 {
      text-align: center;
    }
    #qrCodeContainer {
      margin-top: 54px;
      background: white;
      padding: 10px;
      border-radius: 8px;
      display: none;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.0/build/qrcode.min.js"></script>
</head>
<body>
  <div id="settings">
    <h1>Web Photobooth</h1>

    <label>Pilih Jumlah Foto:</label>
    <div>
      <button onclick="setFrameSize(1)">1</button>
      <button onclick="setFrameSize(2)">2</button>
      <button onclick="setFrameSize(4)">4</button>
    </div>

    <select id="cameraSelect"></select>

    <label>Pilih Frame :</label>
    <div>
      <button onclick="selectDefaultFrame()">Default</button>
      <input type="file" id="frameFile" accept="image/*" onchange="uploadCustomFrame(event)" style="display:none;" />
      <button onclick="document.getElementById('frameFile').click()">Upload Frame</button>
    </div>

    <div id="counter">Foto Tersimpan : 0 / 4</div>
    <button id="capture">Take a Photo ðŸ˜‰</button>
    <div style="margin-top: 54px; display: flex; flex-direction: column; gap: 10px;">
      <button id="downloadBtn">Unduh Hasil</button>
      <button id="printBtn">Cetak</button>
      <button id="resetBtn">Reset</button>
    </div>
    <div id="qrCodeContainer">
      <p style="color: black; margin: 0 0 8px 0">Scan untuk mengunduh:</p>
      <canvas id="qrCanvas"></canvas>
    </div>
  </div>

  <div id="preview">
    <div id="frameDisplay">
      <div id="defaultBackground" style="position:absolute; top:0; left:0; width:1080px; height:3456px; background:white; z-index:1;"></div>
      <img id="frameOverlay" class="frameOverlay" style="display: none;" />
    </div>
  </div>

  <script>
    const cameraSelect = document.getElementById("cameraSelect");
    const frameDisplay = document.getElementById("frameDisplay");
    const frameOverlay = document.getElementById("frameOverlay");
    const counter = document.getElementById("counter");
    const qrCanvas = document.getElementById("qrCanvas");
    const qrCodeContainer = document.getElementById("qrCodeContainer");

    let currentStream = null;
    let photoTaken = 0;
    let totalPhotos = 4;
    let capturedImages = [];
    let video = document.createElement("video");
    video.autoplay = true;
    video.playsInline = true;
    let useDefaultFrame = true;

    function updateCounter() {
      counter.textContent = `Foto Tersimpan : ${photoTaken} / ${totalPhotos}`;
    }

    function createSlot(index) {
      const slot = document.createElement("div");
      slot.className = "slot";
      slot.style.top = `${54 + index * (729 + 54)}px`;
      return slot;
    }

    function initSlots() {
      frameDisplay.querySelectorAll(".slot").forEach(el => el.remove());
      for (let i = 0; i < totalPhotos; i++) {
        const slot = createSlot(i);
        frameDisplay.appendChild(slot);
      }
      const firstSlot = frameDisplay.querySelector(".slot");
      if (firstSlot) firstSlot.appendChild(video);
    }

    function initCamera(deviceId) {
      if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
      }
      const constraints = {
        video: deviceId ? { deviceId: { exact: deviceId } } : true,
      };
      navigator.mediaDevices.getUserMedia(constraints).then((stream) => {
        currentStream = stream;
        video.srcObject = stream;
        const currentSlot = frameDisplay.querySelector(".slot");
        if (currentSlot && !currentSlot.contains(video)) {
          currentSlot.appendChild(video);
        }
      });
    }

    navigator.mediaDevices.enumerateDevices().then((devices) => {
      const videoDevices = devices.filter((d) => d.kind === "videoinput");
      videoDevices.forEach((device) => {
        const option = document.createElement("option");
        option.value = device.deviceId;
        option.text = device.label || "Camera";
        cameraSelect.appendChild(option);
      });
      if (videoDevices.length > 0) initCamera(videoDevices[0].deviceId);
    });

    cameraSelect.addEventListener("change", () => {
      initCamera(cameraSelect.value);
    });

    function setFrameSize(num) {
      totalPhotos = num;
      photoTaken = 0;
      capturedImages = [];
      frameDisplay.style.height = num === 1 ? "1107px" : num === 2 ? "1890px" : "3456px";
      updateCounter();
      initSlots();
    }

    function selectDefaultFrame() {
      useDefaultFrame = true;
      frameOverlay.style.display = "none";
      document.getElementById("defaultBackground").style.display = "block";
      initSlots();
    }

    function uploadCustomFrame(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    useDefaultFrame = false;
    // Jangan sembunyikan defaultBackground agar tetap jadi background
    frameOverlay.src = reader.result;
    frameOverlay.style.display = "block";
    initSlots();
  };
  reader.readAsDataURL(file);
}

    document.getElementById("capture").addEventListener("click", () => {
      const slot = frameDisplay.querySelectorAll(".slot")[photoTaken];
      if (!slot) return;

      const img = document.createElement("img");
      img.className = "photo";

      const tempCanvas = document.createElement("canvas");
      const ctx = tempCanvas.getContext("2d");
      const aspectRatio = 972 / 729;
      let cropWidth = video.videoWidth;
      let cropHeight = cropWidth / aspectRatio;

      if (cropHeight > video.videoHeight) {
        cropHeight = video.videoHeight;
        cropWidth = cropHeight * aspectRatio;
      }

      const sx = (video.videoWidth - cropWidth) / 2;
      const sy = (video.videoHeight - cropHeight) / 2;

      tempCanvas.width = 972;
      tempCanvas.height = 729;

      ctx.drawImage(video, sx, sy, cropWidth, cropHeight, 0, 0, 972, 729);

      img.src = tempCanvas.toDataURL("image/jpeg");
      slot.innerHTML = "";
      slot.appendChild(img);

      capturedImages.push(tempCanvas);
      photoTaken++;
      updateCounter();

      const nextSlot = frameDisplay.querySelectorAll(".slot")[photoTaken];
      if (nextSlot) {
        nextSlot.appendChild(video);
      }
    });

    document.getElementById("resetBtn").addEventListener("click", () => {
      photoTaken = 0;
      capturedImages = [];
      qrCodeContainer.style.display = "none";
      updateCounter();
      initSlots();
      initCamera(cameraSelect.value);
    });

    document.getElementById("printBtn").addEventListener("click", () => {
      renderPhotostrip((canvas) => {
        const win = window.open();
        win.document.write(`<img src="${canvas.toDataURL()}" onload="window.print();window.close();" />`);
        win.document.close();
      });
    });

    function uploadToImgbb(dataUrl, callback) {
      const apiKey = "c3f4ab95d6474bbce981d20cb0980cf6";
      const formData = new FormData();
      formData.append("image", dataUrl.split(",")[1]);

      fetch("https://api.imgbb.com/1/upload?expiration=600&key=" + apiKey, {
        method: "POST",
        body: formData,
      })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            callback(data.data.url);
          } else {
            alert("Upload gagal");
          }
        })
        .catch(err => {
          console.error("Upload error:", err);
        });
    }

    function showQRCode(url) {
      QRCode.toCanvas(qrCanvas, url, { width: 180 }, function (error) {
        if (error) console.error(error);
        qrCodeContainer.style.display = "block";
      });
    }

    function renderPhotostrip(callback) {
      const canvas = document.createElement("canvas");
      canvas.width = 1080;
      canvas.height = frameDisplay.offsetHeight;
      const ctx = canvas.getContext("2d");

      if (useDefaultFrame) {
        ctx.fillStyle = "white";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      }

      for (let i = 0; i < capturedImages.length; i++) {
        ctx.drawImage(capturedImages[i], 0, 0, 972, 729, 54, 54 + i * (729 + 54), 972, 729);
      }

      if (!useDefaultFrame && frameOverlay.src) {
        const img = new Image();
        img.onload = () => {
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          callback(canvas);
        };
        img.src = frameOverlay.src;
      } else {
        callback(canvas);
      }
    }

    document.getElementById("downloadBtn").addEventListener("click", () => {
      renderPhotostrip((canvas) => {
        const link = document.createElement("a");
        link.download = "photostrip.png";
        link.href = canvas.toDataURL();
        link.click();
        uploadToImgbb(canvas.toDataURL(), showQRCode);
      });
    });

    updateCounter();
    initSlots();
  </script>
</body>
</html>
