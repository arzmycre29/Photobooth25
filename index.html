<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cheki Yuu</title>
    <style>
      body {
        font-family: sans-serif;
        background: #311183;
        color: white;
        margin: 0;
        padding: 1rem;
        height: 100vh;
        display: flex;
        flex-direction: row;
        gap: 2rem;
        overflow: hidden;
      }

      #settings {
        width: 300px;
        display: flex;
        flex-direction: column;
        gap: 20px;
        overflow-y: auto;
        padding-right: 10px;
      }

      #preview,
      #videoResultContainer {
        flex: 1;
        overflow: auto;
        display: flex;
        justify-content: center;
        align-items: start;
        padding-top: 20px;
        position: relative;
      }

      #frameDisplay {
        position: relative;
        width: 1080px;
        transition: height 0.3s ease-in-out;
      }

      #defaultBackground {
        position: absolute;
        top: 0;
        left: 0;
        width: 1080px;
        background: white;
        z-index: 1;
        transition: height 0.3s ease-in-out;
      }

      .frameOverlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 1080px;
        height: 100%;
        z-index: 10;
        pointer-events: none;
      }

      .slot {
        width: 972px;
        height: 729px;
        position: absolute;
        left: 54px;
        overflow: hidden;
        background-color: #e0e0e0;
      }

      .slot video,
      .slot img.photo {
        width: 100%;
        height: 100%;
        object-fit: cover;
        position: absolute;
        top: 0;
        left: 0;
        z-index: 5;
      }

      select,
      button {
        padding: 0.5rem;
        font-size: 1rem;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      button {
        background: #fff;
        color: #311183;
        font-weight: bold;
      }

      button:hover {
        background-color: #f0f0f0;
      }

      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      h1 {
        text-align: center;
      }

      #qrCodeContainer {
        margin-top: 20px;
        background: white;
        padding: 10px;
        border-radius: 8px;
        display: none;
      }

      #countdownOverlay {
        position: absolute;
        transform: translate(-50%, -50%);
        font-size: 15rem;
        font-weight: bold;
        color: white;
        text-shadow: 0 0 25px rgba(0, 0, 0, 0.8);
        z-index: 100;
        display: none;
        pointer-events: none;
      }

      .button-group {
        margin-top: 20px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      #videoResultContainer {
        flex-direction: column;
        align-items: center;
        gap: 1.5rem;
      }

      #videoPlayer {
        width: 80%;
        max-width: 900px;
        border: 4px solid white;
        border-radius: 8px;
      }

      #downloadLinks {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        justify-content: center;
      }

      #downloadLinks a {
        background-color: white;
        color: #311183;
        padding: 10px 15px;
        border-radius: 8px;
        text-decoration: none;
        font-weight: bold;
        transition: transform 0.2s;
      }

      #downloadLinks a:hover {
        transform: scale(1.05);
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.0/build/qrcode.min.js"></script>
  </head>
  <body>
    <div id="settings">
      <h1>Cheki Yuu Photobooth</h1>
      <label>Pilih Jumlah Foto:</label>
      <div>
        <button onclick="setFrameSize(1)">1</button>
        <button onclick="setFrameSize(2)">2</button>
        <button onclick="setFrameSize(4)">4</button>
      </div>
      <select id="cameraSelect"></select>
      <label>Pilih Frame:</label>
      <div>
        <button onclick="selectDefaultFrame()">Default</button>
        <input type="file" id="frameFile" accept="image/*" onchange="uploadCustomFrame(event)" style="display:none;" />
        <button onclick="document.getElementById('frameFile').click()">Upload Frame</button>
      </div>
      <div id="counter">Foto Tersimpan: 0 / 4</div>
      <button id="capture">Take a Photo üòâ</button>
      <div class="button-group">
        <button id="downloadBtn">Unduh Hasil Foto</button>
        <button id="printBtn">Cetak</button>
        <button id="showVideosBtn" style="display: none;">Lihat Klip Video üé¨</button>
        <button id="resetBtn">Reset / Mulai Lagi</button>
      </div>
      <div id="qrCodeContainer">
        <p style="color: black; margin: 0 0 8px 0">Scan untuk mengunduh:</p>
        <canvas id="qrCanvas"></canvas>
      </div>
    </div>
    <div id="preview">
      <div id="countdownOverlay">3</div>
      <div id="frameDisplay">
        <div id="defaultBackground"></div>
        <img id="frameOverlay" class="frameOverlay" style="display: none;" />
      </div>
    </div>
    <div id="videoResultContainer" style="display: none;">
      <h2>Hasil Video Anda</h2>
      <video id="videoPlayer" controls autoplay muted playsinline></video>
      <div id="downloadLinks"></div>
      <p style="font-size: 0.9rem; opacity: 0.8;">Video akan diputar otomatis satu per satu.</p>
      <button id="backToPhotoBtn" style="margin-top: 1rem;">Kembali ke Hasil Foto üñºÔ∏è</button>
    </div>
    <script>
      const CONFIG = {
        slotWidth: 972,
        slotHeight: 729,
        margin: 54,
        imgbbApiKey: "c3f4ab95d6474bbce981d20cb0980cf6"
      };
      const cameraSelect = document.getElementById("cameraSelect");
      const frameDisplay = document.getElementById("frameDisplay");
      const frameOverlay = document.getElementById("frameOverlay");
      const defaultBackground = document.getElementById("defaultBackground");
      const counter = document.getElementById("counter");
      const qrCanvas = document.getElementById("qrCanvas");
      const qrCodeContainer = document.getElementById("qrCodeContainer");
      const captureButton = document.getElementById("capture");
      const countdownOverlay = document.getElementById("countdownOverlay");
      const previewContainer = document.getElementById("preview");
      const videoResultContainer = document.getElementById("videoResultContainer");
      const videoPlayer = document.getElementById("videoPlayer");
      const downloadLinksContainer = document.getElementById("downloadLinks");
      const showVideosBtn = document.getElementById("showVideosBtn");
      const backToPhotoBtn = document.getElementById("backToPhotoBtn");
      let currentStream = null,
        photoTaken = 0,
        totalPhotos = 4;
      let capturedImages = [],
        capturedVideos = [];
      let video = document.createElement("video");
      video.autoplay = true;
      video.playsInline = true;
      let useDefaultFrame = true;
      let mediaRecorder, recordedChunks = [];
      let currentVideoIndex = 0;

      function updateCounter() {
        counter.textContent = `Foto Tersimpan: ${photoTaken} / ${totalPhotos}`;
      }

      function createSlot(index) {
        const slot = document.createElement("div");
        slot.className = "slot";
        slot.style.top = `${CONFIG.margin + index * (CONFIG.slotHeight + CONFIG.margin)}px`;
        return slot;
      }

      function initSlots() {
        frameDisplay.querySelectorAll(".slot").forEach(el => el.remove());
        for (let i = 0; i < totalPhotos; i++) {
          const slot = createSlot(i);
          frameDisplay.appendChild(slot);
        }
        const firstSlot = frameDisplay.querySelector(".slot");
        if (firstSlot && !firstSlot.contains(video)) firstSlot.appendChild(video);
      }
      async function initCamera(deviceId) {
        if (currentStream) {
          currentStream.getTracks().forEach(track => track.stop());
        }
        const constraints = {
          video: deviceId ? {
            deviceId: {
              exact: deviceId
            }
          } : {
            facingMode: 'user'
          }
        };
        try {
          const stream = await navigator.mediaDevices.getUserMedia(constraints);
          currentStream = stream;
          video.srcObject = stream;
          const currentSlot = frameDisplay.querySelectorAll(".slot")[photoTaken] || frameDisplay.querySelector(".slot");
          if (currentSlot && !currentSlot.contains(video)) {
            currentSlot.innerHTML = '';
            currentSlot.appendChild(video);
          }
        } catch (err) {
          console.error("Gagal mengakses kamera:", err);
          alert("Tidak bisa mengakses kamera. Pastikan Anda memberikan izin.");
        }
      }
      async function loadCameras() {
        try {
          const devices = await navigator.mediaDevices.enumerateDevices();
          const videoDevices = devices.filter((d) => d.kind === "videoinput");
          cameraSelect.innerHTML = '';
          videoDevices.forEach((device) => {
            const option = document.createElement("option");
            option.value = device.deviceId;
            option.text = device.label || `Kamera ${cameraSelect.length + 1}`;
            cameraSelect.appendChild(option);
          });
          if (videoDevices.length > 0) await initCamera(videoDevices[0].deviceId);
        } catch (err) {
          console.error("Tidak bisa mendapatkan daftar perangkat:", err);
        }
      }

      function setFrameSize(num) {
        totalPhotos = num;
        let newHeight;
        switch (num) {
          case 1:
            newHeight = 1107;
            break;
          case 2:
            newHeight = 1890;
            break;
          case 4:
          default:
            newHeight = 3456;
            break;
        }
        frameDisplay.style.height = `${newHeight}px`;
        defaultBackground.style.height = `${newHeight}px`;
        resetApp();
      }

      function selectDefaultFrame() {
        useDefaultFrame = true;
        frameOverlay.style.display = "none";
        defaultBackground.style.display = "block";
      }

      function uploadCustomFrame(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          useDefaultFrame = false;
          frameOverlay.src = reader.result;
          frameOverlay.style.display = "block";
          defaultBackground.style.display = "none";
        };
        reader.readAsDataURL(file);
      }

      function startCaptureProcess() {
        const slot = frameDisplay.querySelectorAll(".slot")[photoTaken];
        if (!slot || photoTaken >= totalPhotos || !currentStream) return;
        captureButton.disabled = true;
        captureButton.textContent = "Siap-siap...";
        recordedChunks = [];
        mediaRecorder = new MediaRecorder(currentStream, {
          mimeType: 'video/webm'
        });
        mediaRecorder.ondataavailable = (event) => {
          if (event.data.size > 0) recordedChunks.push(event.data);
        };
        mediaRecorder.onstop = () => {
          const videoBlob = new Blob(recordedChunks, {
            type: 'video/webm'
          });
          const videoUrl = URL.createObjectURL(videoBlob);
          capturedVideos.push(videoUrl);
          console.log(`Video ke-${capturedVideos.length} berhasil direkam.`);
        };
        mediaRecorder.start();
        const slotRect = slot.getBoundingClientRect();
        const previewRect = frameDisplay.getBoundingClientRect();
        countdownOverlay.style.top = `${slotRect.top - previewRect.top + (slotRect.height / 2)}px`;
        countdownOverlay.style.left = `50%`;
        let count = 3;
        countdownOverlay.textContent = count;
        countdownOverlay.style.display = "block";
        const countdownInterval = setInterval(() => {
          count--;
          if (count > 0) {
            countdownOverlay.textContent = count;
          } else {
            clearInterval(countdownInterval);
            countdownOverlay.style.display = "none";
            if (mediaRecorder.state === 'recording') mediaRecorder.stop();
            takeFinalPhoto(slot);
            if (photoTaken < totalPhotos) {
              captureButton.disabled = false;
              captureButton.textContent = "Take a Photo üòâ";
            }
          }
        }, 1000);
      }

      function takeFinalPhoto(slot) {
        const img = document.createElement("img");
        img.className = "photo";
        const tempCanvas = document.createElement("canvas");
        const ctx = tempCanvas.getContext("2d");
        const aspectRatio = CONFIG.slotWidth / CONFIG.slotHeight;
        let cropWidth = video.videoWidth,
          cropHeight = cropWidth / aspectRatio;
        if (cropHeight > video.videoHeight) {
          cropHeight = video.videoHeight;
          cropWidth = cropHeight * aspectRatio;
        }
        const sx = (video.videoWidth - cropWidth) / 2;
        const sy = (video.videoHeight - cropHeight) / 2;
        tempCanvas.width = CONFIG.slotWidth;
        tempCanvas.height = CONFIG.slotHeight;
        ctx.drawImage(video, sx, sy, cropWidth, cropHeight, 0, 0, CONFIG.slotWidth, CONFIG.slotHeight);
        img.src = tempCanvas.toDataURL("image/jpeg");
        slot.innerHTML = "";
        slot.appendChild(img);
        capturedImages.push(tempCanvas);
        photoTaken++;
        updateCounter();
        const nextSlot = frameDisplay.querySelectorAll(".slot")[photoTaken];
        if (nextSlot) {
          nextSlot.appendChild(video);
        } else {
          if (currentStream) currentStream.getTracks().forEach(track => track.stop());
          video.remove();
          captureButton.textContent = "Selesai!";
          captureButton.disabled = true;
          showVideosBtn.style.display = 'block';
        }
      }

      function showVideoResult() {
        previewContainer.style.display = 'none';
        videoResultContainer.style.display = 'flex';
        currentVideoIndex = 0;
        downloadLinksContainer.innerHTML = '';
        capturedVideos.forEach((videoUrl, index) => {
          const link = document.createElement('a');
          link.href = videoUrl;
          link.download = `photobooth-klip-${index + 1}.webm`;
          link.textContent = `Unduh Klip ${index + 1}`;
          downloadLinksContainer.appendChild(link);
        });
        videoPlayer.onended = () => {
          currentVideoIndex++;
          if (currentVideoIndex < capturedVideos.length) {
            videoPlayer.src = capturedVideos[currentVideoIndex];
            videoPlayer.play();
          } else {
            currentVideoIndex = 0;
            videoPlayer.src = capturedVideos[currentVideoIndex];
            videoPlayer.play();
          }
        };
        if (capturedVideos.length > 0) {
          videoPlayer.src = capturedVideos[0];
          videoPlayer.play();
        }
      }

      function resetApp() {
        previewContainer.style.display = 'flex';
        videoResultContainer.style.display = 'none';
        showVideosBtn.style.display = 'none';
        photoTaken = 0;
        capturedImages = [];
        capturedVideos = [];
        qrCodeContainer.style.display = "none";
        captureButton.disabled = false;
        captureButton.textContent = "Take a Photo üòâ";
        updateCounter();
        initSlots();
        loadCameras();
      }

      function renderPhotostrip(callback) {
        const canvas = document.createElement("canvas");
        canvas.width = 1080;
        canvas.height = frameDisplay.offsetHeight;
        const ctx = canvas.getContext("2d");
        if (useDefaultFrame) {
          ctx.fillStyle = "white";
          ctx.fillRect(0, 0, canvas.width, canvas.height);
        }
        for (let i = 0; i < capturedImages.length; i++) {
          ctx.drawImage(capturedImages[i], CONFIG.margin, CONFIG.margin + i * (CONFIG.slotHeight + CONFIG.margin));
        }
        if (!useDefaultFrame && frameOverlay.src) {
          const img = new Image();
          img.onload = () => {
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            callback(canvas);
          };
          img.src = frameOverlay.src;
        } else {
          callback(canvas);
        }
      }
      // --- MODIFIKASI DIMULAI ---
      async function uploadToImgbb(dataUrl, filename) {
        const formData = new FormData();
        formData.append("image", dataUrl.split(",")[1]);
        formData.append("name", filename); // Menambahkan nama file ke FormData
        try {
          const response = await fetch(`https://api.imgbb.com/1/upload?key=${CONFIG.imgbbApiKey}`, {
            method: "POST",
            body: formData
          });
          const data = await response.json();
          if (data.success) return data.data.url;
          else throw new Error(data.error.message);
        } catch (err) {
          console.error("Upload error:", err);
          alert("Upload gagal: " + err.message);
          return null;
        }
      }
      // --- MODIFIKASI SELESAI ---
      function showQRCode(url) {
        QRCode.toCanvas(qrCanvas, url, {
          width: 180
        }, (error) => {
          if (error) console.error(error);
          qrCodeContainer.style.display = "block";
        });
      }
      cameraSelect.addEventListener("change", () => initCamera(cameraSelect.value));
      captureButton.addEventListener("click", startCaptureProcess);
      document.getElementById("resetBtn").addEventListener("click", resetApp);
      document.getElementById("printBtn").addEventListener("click", () => {
        renderPhotostrip((canvas) => {
          const win = window.open();
          win.document.write(`
			<img src="${canvas.toDataURL()}" onload="window.print();window.close();" />`);
          win.document.close();
        });
      });
      // --- MODIFIKASI DIMULAI ---
      document.getElementById("downloadBtn").addEventListener("click", () => {
        renderPhotostrip(async (canvas) => {
          // Membuat nama file yang unik menggunakan timestamp
          const filename = `photostrip-${Date.now()}.png`;
          const dataUrl = canvas.toDataURL("image/png");
          const link = document.createElement("a");
          link.download = filename; // Menggunakan nama file unik untuk unduhan lokal
          link.href = dataUrl;
          link.click();
          // Mengirim dataUrl beserta nama file unik ke fungsi upload
          const uploadedUrl = await uploadToImgbb(dataUrl, filename);
          if (uploadedUrl) showQRCode(uploadedUrl);
        });
      });
      // --- MODIFIKASI SELESAI ---
      showVideosBtn.addEventListener("click", () => {
        showVideoResult();
      });
      backToPhotoBtn.addEventListener("click", () => {
        videoResultContainer.style.display = 'none';
        previewContainer.style.display = 'flex';
        videoPlayer.pause();
      });

      function initializeApp() {
        setFrameSize(4);
        loadCameras();
      }
      initializeApp();
    </script>
  </body>
</html>

